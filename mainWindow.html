<!DOCTYPE html>
<html lang="en">
<head id="header">
    <title>Bot GUI</title>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"> -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
        body {
            overflow-x: hidden;
            overflow-y: hidden;
        }
    </style>
    <!--<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="crossorigin="anonymous">
        console.log("jQuery Loaded!")
    </script>-->
</head>
<body style="background-color:rgb(49, 49, 49)">
    <header class="navbar text-center" style="background-color:black; margin-bottom:0%">
        <h1 style="color:lightgrey" id="name">
            Bot GUI
        </h1>
    </header>
    <div>
        <div id="info" style="background-color:grey; color:white">
            <div id="bot-info1">
                test
            </div>
            <div id="bot-info2">
                dsa
            </div>
            <div id="bot-info3">
                gfd
            </div>
            <div id="bot-info4">
                vcx
            </div>
        </div>
        <div>
            <div class="container col-sm-10" style="padding-left:0%; padding-right:0%">
                <div style="height:66.5vh; overflow-y:auto; background-color:rgb(41, 41, 41); color:white; padding-left:0%; padding-right:0%" id="chat-log">
                    <ul class="list-group bottom-right" id="messages" style="vertical-align:bottom; padding-left:0%; padding-right:0%"></ul>
                </div>
            </div>
            <div class="col-sm-2" style="height:66.5vh; background-color:white; border-left: thick double black;">
                <nav>
                    <div>
                        Hey
                    </div>
                    <div>
                        There
                    </div>
                </nav>
            </div>
            <footer class="navbar-fixed-bottom" style="background-color:rgb(24, 24, 24); border-top: thick double black">
                <h1>CHATBAR</h1>
            </footer>
        </div>
    </div>
    
    
    <script>
        const ul = document.querySelector('ul');
        const head = document.head;
        const electron = require('electron');
        const {ipcRenderer} = electron;
        ipcRenderer.on('message:clear', function(){
            ul.innerHTML = '';
        });
        function sleep(milliseconds) {
            var start = new Date().getTime();
            for (var i = 0; i < 1e7; i++) {
                if ((new Date().getTime() - start) > milliseconds){
                break;
                }
            }
        }
        function scrollToBottom (id) {
            var div = document.getElementById(id);
            div.scrollTop = div.scrollHeight - div.clientHeight +10;
        }
        function scrollToTop (id) {
            var div = document.getElementById(id);
            div.scrollTop = 0;
        }
            //Require jQuery
        function scrollSmoothToBottom (id) {
            var div = document.getElementById(id);
            $('#' + id).animate({
                scrollTop: div.scrollHeight - div.clientHeight
            }, 500);
        }
            //Require jQuery
        function scrollSmoothToTop (id) {
            var div = document.getElementById(id);
            $('#' + id).animate({
                scrollTop: 0
            }, 500);
        }
        function botIsON(){
            console.log("botIsON ran")
            document.getElementById("name").textContent = bot.user.username + " - GUI"

            // Responses

            bot.on('message', function(message){
                scrollToBottom("chat-log");

                const gotMessageDetailed = message.author+" - "+message.channel+" - "+message.createdAt+" - "+message.author.username+" - "+": "+message.content;
                const commandEvoked = "User: [" + message.author.username + "] attemped to evoke command: " + message.content

                const li = document.createElement('li');
                var logged;
                li.className = "list-group-item message";

                if(message.channel.type == "dm"){
                    const gotMessageDMSimple = message.author.username+" - " + message.channel + ": "+message.content;
                    gotMessageSimple = gotMessageDMSimple;
                } else {
                    const gotMessageGuildSimple = message.author.username+" - " + message.guild.name + "|" + message.channel + ": "+message.content;
                    gotMessageSimple = gotMessageGuildSimple;
                }

                if(message.content.toLowerCase().startsWith(prefix)){
                    logged = document.createTextNode(commandEvoked);
                    li.style = "background-color:#004d00;";
                }else{
                    if(message.author.id == bot.user.id){
                        li.style = "background-color:#b3b300; color:#990000";
                        logged = document.createTextNode(gotMessageSimple);
                        if(message.channel.type == "dm"){
                            li.style = "background-color:#0066cc;";
                        }
                    }else{
                        li.style = "background-color:black; vertical-align:bottom";
                        logged = document.createTextNode(gotMessageSimple);
                        if(message.channel.type == "dm"){
                            li.style = "background-color:#cc0066;";
                        }
                    }
                }
                li.appendChild(logged);
                ul.appendChild(li);
            });
            bot.on('messageDelete', function(message){
                const messageDeleted = "User: [" + message.author.username + "] deleted message: " + message.content
                scrollToBottom("chat-log");
                const li = document.createElement('li');
                var logged;
                li.className = "list-group-item message";
                logged = document.createTextNode(messageDeleted);
                li.style = "background-color:#004d00;";
                li.appendChild(logged);
                ul.appendChild(li);
            });
            bot.on('messageUpdate', function(oldMessage, newMessage){
                const messageUpdated = "User: [" + oldMessage.author.username + "] updated message: <b>'" + oldMessage.content + "'</b> => **'" + newMessage.content + "'**"
                scrollToBottom("chat-log");
                const li = document.createElement('li');
                var logged;
                li.className = "list-group-item message";
                logged = document.createTextNode(messageUpdated);
                li.style = "background-color:#004d00;";
                li.appendChild(logged);
                ul.appendChild(li);
            });
        }

        ipcRenderer.on('bot:add', function(e, botLocation){
            const script = document.createElement('script');
            script.src = botLocation;
            head.appendChild(script)
            setTimeout(botIsON,4000)
        });

        tokenLogon(token){
            bot.login(token);
        }

        ipcRenderer.on('token:add', function(e, token){
            const script = document.createElement('script');
            script.src = "./tokenMonitor.js";
            head.appendChild(script)
            setTimeout(tokenLogon(token), 3000)
            setTimeout(botIsON,5000)
        });

        //Remove Item
        ul.addEventListener('dblclick', removeItem);
        function removeItem(e){
            e.target.remove();
            // bot.channel.fetchMessage(message.channel.lastMessageID)
            /*if(ul.children.length == 0){                
                ul.className = '';
            }*/
            
        }
    </script>
</body>
</html>